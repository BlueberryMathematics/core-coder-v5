"""
Core Coder V5 - Custom CLI Agent
A custom CLI agent created with Agent Forge

Generated by Agent Forge

================================================================================
FACTORY FUNCTION PATTERN - EXECUTION FLOW
================================================================================

This file uses a factory function pattern for agent creation:

┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 1: Define Factory Function (line ~215)                             │
│ ─────────────────────────────────────────────────────────────────────── │
│   def create_core_coder_v5_agent(project_root=".", **kwargs):           │
│       # ... dynamically load tools from toolboxes ...                   │
│       # ... setup middleware if enabled ...                             │
│       agent = Agent(tools=tools, middleware=middleware, ...)            │
│       return agent                                                      │
│                                                                          │
│   Purpose: Function definition only - NOT executed yet!                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 2: Assign Factory to Variable (line ~320)                          │
│ ─────────────────────────────────────────────────────────────────────── │
│   CoreCoderV5 = create_core_coder_v5_agent  # NO () - assign function! │
│                                                                          │
│   ✅ CORRECT: Assigns the function itself                               │
│   ❌ WRONG:   CoreCoderV5 = create_core_coder_v5_agent()                │
│              (would create instance immediately - TypeError later!)     │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│ STEP 3: CLI Calls Factory (line ~370)                                   │
│ ─────────────────────────────────────────────────────────────────────── │
│   def main():                                                           │
│       agent = CoreCoderV5(enable_memory=True, enable_rag=False)        │
│                  ↑                                                      │
│                  └─ NOW we call the function with ()                   │
│                     Creates Agent instance with parameters             │
└─────────────────────────────────────────────────────────────────────────┘

KEY POINTS:
- Factory pattern allows runtime configuration via parameters
- Multiple agents can be created with different settings
- Dynamic tool loading based on selected toolboxes
- Supports multi-agent types: coding, math, science, hybrid

================================================================================
"""

import os
import sys
from pathlib import Path
from typing import List, Optional
from langchain_core.tools import tool

# Enable ANSI color codes on Windows (MUST be done early!)
try:
    from colorama import just_fix_windows_console
    just_fix_windows_console()
except ImportError:
    pass  # colorama not available, colors may not work on Windows

# Add langchain-agent-base to path
sys.path.insert(0, str(Path(__file__).parent / "langchain-agent-base" / "src"))

from base import Agent
from toolbox import get_toolbox
from protocol import register_agent, AgentStatus

# For shell middleware
try:
    from langchain.agents.middleware import ShellToolMiddleware, HostExecutionPolicy
    SHELL_MIDDLEWARE_AVAILABLE = True
except ImportError:
    SHELL_MIDDLEWARE_AVAILABLE = False
    print("WARNING: ShellToolMiddleware not available - install langchain.agents.middleware")


# ============================================================================
# SIMPLE CONVERSATION MEMORY (No external dependencies)
# ============================================================================

class SimpleConversationMemory:
    """Simple in-memory conversation history that works without Qdrant.
    
    This provides basic conversation memory without requiring external services.
    History persists only during the session but ensures context is maintained.
    """
    
    def __init__(self, max_messages: int = 20):
        """Initialize simple memory.
        
        Args:
            max_messages: Maximum number of message pairs to keep
        """
        self.max_messages = max_messages
        self.history = {}  # session_id -> list of {"message": str, "response": str}
    
    def add_message(self, session_id: str, message: str, response: str):
        """Add a message-response pair to history."""
        if session_id not in self.history:
            self.history[session_id] = []
        
        self.history[session_id].append({
            "message": message,
            "response": response
        })
        
        # Keep only the last N messages
        if len(self.history[session_id]) > self.max_messages:
            self.history[session_id] = self.history[session_id][-self.max_messages:]
    
    def get_history(self, session_id: str, limit: int = None) -> list:
        """Get conversation history for a session."""
        history = self.history.get(session_id, [])
        if limit:
            return history[-limit:]
        return history
    
    def clear(self, session_id: str = None):
        """Clear history for a session or all sessions."""
        if session_id:
            self.history.pop(session_id, None)
        else:
            self.history.clear()
    
    def get_message_count(self, session_id: str) -> int:
        """Get number of messages in a session."""
        return len(self.history.get(session_id, []))


# Global simple memory instance (persists across agent reinitializations)
_simple_memory = SimpleConversationMemory()


# ============================================================================
# AGENT CONFIGURATION (from UI)
# ============================================================================
# All configuration comes from the UI builder - this is the metadata layer.
# The factory function below uses this config to build the agent dynamically.
# ============================================================================

AGENT_CONFIG = {
    'name': 'core_coder_v5',
    'display_name': 'Core Coder V5',
    'model': 'qwen3:1.7b',
    'provider': 'ollama',
    'temperature': 0.7,
    'max_tokens': 4096,
    'memory_enabled': True,
    'rag_enabled': True,
    'enable_shell': True,
    'toolboxes': ["coding"],  # Dynamic tool loading!
    'color_scheme': 'custom',
    'colors': {"primary":"#f0bcf1","secondary":"#75f320","success":"#00fae9","error":"#f32b35","warning":"#f1db4b","info":"#f736dd","tool":"#0a89eb","shell":"#7b50f2","accent":"#34f9ad"},
    'ascii_art_color': '#00ff40',
    'show_pixel_art': True,
    'banner_order': 'pixel-first',
    'ascii_art': """   ______                   ______          __             _    ________
  / ____/___  ________     / ____/___  ____/ /__  _____   | |  / / ____/
 / /   / __ \/ ___/ _ \   / /   / __ \/ __  / _ \/ ___/   | | / /___ \  
/ /___/ /_/ / /  /  __/  / /___/ /_/ / /_/ /  __/ /       | |/ /___/ /  
\____/\____/_/   \___/   \____/\____/\__,_/\___/_/        |___/_____/   
                                                                        """,
    'pixel_ascii_art': """                                        \n                 \x1b[38;2;74;149;19m\x1b[48;2;146;247;44m▀\x1b[0m\x1b[38;2;125;238;29m\x1b[48;2;95;188;34m▀\x1b[0m\x1b[38;2;119;228;30m\x1b[48;2;49;149;12m▀\x1b[0m\x1b[38;2;109;223;24m\x1b[48;2;50;154;11m▀\x1b[0m\x1b[38;2;89;213;17m\x1b[48;2;77;192;17m▀\x1b[0m\x1b[38;2;80;205;14m▄\x1b[0m                 \n               \x1b[38;2;95;197;23m\x1b[48;2;115;232;30m▀\x1b[0m\x1b[38;2;70;163;30m\x1b[48;2;22;130;3m▀\x1b[0m\x1b[38;2;20;115;3m▀\x1b[0m    \x1b[38;2;29;145;5m\x1b[48;2;19;102;5m▀\x1b[0m\x1b[38;2;67;190;13m\x1b[48;2;48;170;9m▀\x1b[0m\x1b[38;2;37;124;7m\x1b[48;2;48;171;8m▀\x1b[0m               \n               \x1b[38;2;78;189;21m\x1b[48;2;69;185;16m▀\x1b[0m  \x1b[38;2;74;191;17m\x1b[48;2;57;184;12m▀\x1b[0m\x1b[38;2;178;250;91m\x1b[48;2;79;204;17m▀\x1b[0m\x1b[38;2;61;188;7m\x1b[48;2;36;155;4m▀\x1b[0m\x1b[38;2;21;99;4m\x1b[48;2;21;102;5m▀\x1b[0m \x1b[38;2;39;161;6m\x1b[48;2;42;164;7m▀\x1b[0m\x1b[38;2;51;169;9m\x1b[48;2;52;165;10m▀\x1b[0m               \n               \x1b[38;2;55;180;11m\x1b[48;2;46;171;9m▀\x1b[0m\x1b[38;2;39;156;5m\x1b[48;2;55;181;7m▀\x1b[0m  \x1b[38;2;30;127;6m▀\x1b[0m\x1b[38;2;28;118;7m▀\x1b[0m \x1b[38;2;43;138;6m▄\x1b[0m\x1b[38;2;78;208;12m\x1b[48;2;90;206;20m▀\x1b[0m\x1b[38;2;19;124;3m\x1b[48;2;22;124;4m▀\x1b[0m               \n                \x1b[38;2;30;140;6m▀\x1b[0m\x1b[38;2;52;169;9m\x1b[48;2;24;134;3m▀\x1b[0m\x1b[38;2;80;209;12m\x1b[48;2;46;154;9m▀\x1b[0m\x1b[38;2;69;200;8m\x1b[48;2;66;180;12m▀\x1b[0m\x1b[38;2;73;205;9m\x1b[48;2;66;178;13m▀\x1b[0m\x1b[38;2;89;209;17m\x1b[48;2;36;134;8m▀\x1b[0m\x1b[38;2;32;130;6m\x1b[48;2;20;122;3m▀\x1b[0m\x1b[38;2;21;117;4m▀\x1b[0m                \n                                        \n        \x1b[38;2;129;233;36m▄\x1b[0m\x1b[38;2;133;237;36m▄\x1b[0m\x1b[38;2;127;235;33m▄\x1b[0m\x1b[38;2;125;234;33m▄\x1b[0m\x1b[38;2;121;232;32m▄\x1b[0m\x1b[38;2;117;231;30m▄\x1b[0m\x1b[38;2;113;230;28m▄\x1b[0m\x1b[38;2;108;227;26m▄\x1b[0m\x1b[38;2;103;224;24m▄\x1b[0m\x1b[38;2;99;221;23m▄\x1b[0m\x1b[38;2;23;142;13m\x1b[48;2;95;219;22m▀\x1b[0m\x1b[38;2;33;161;16m\x1b[48;2;90;216;21m▀\x1b[0m\x1b[38;2;24;138;12m\x1b[48;2;86;211;18m▀\x1b[0m\x1b[38;2;17;95;5m\x1b[48;2;85;207;18m▀\x1b[0m\x1b[38;2;84;211;18m▄\x1b[0m\x1b[38;2;83;212;18m▄\x1b[0m\x1b[38;2;81;212;17m▄\x1b[0m\x1b[38;2;78;209;17m▄\x1b[0m\x1b[38;2;75;207;15m▄\x1b[0m\x1b[38;2;72;206;16m▄\x1b[0m\x1b[38;2;69;203;14m▄\x1b[0m\x1b[38;2;66;201;14m▄\x1b[0m\x1b[38;2;62;196;14m▄\x1b[0m\x1b[38;2;51;179;12m▄\x1b[0m        \n     \x1b[38;2;63;140;14m▄\x1b[0m\x1b[38;2;141;243;41m\x1b[48;2;155;244;65m▀\x1b[0m\x1b[38;2;131;230;59m\x1b[48;2;81;212;15m▀\x1b[0m\x1b[38;2;82;211;17m\x1b[48;2;77;209;15m▀\x1b[0m\x1b[38;2;76;209;16m\x1b[48;2;73;207;15m▀\x1b[0m\x1b[38;2;74;208;15m\x1b[48;2;71;205;14m▀\x1b[0m\x1b[38;2;72;206;14m\x1b[48;2;68;204;14m▀\x1b[0m\x1b[38;2;69;204;14m\x1b[48;2;66;202;14m▀\x1b[0m\x1b[38;2;66;202;14m\x1b[48;2;63;200;13m▀\x1b[0m\x1b[38;2;63;200;14m\x1b[48;2;60;198;13m▀\x1b[0m\x1b[38;2;61;198;13m\x1b[48;2;58;196;13m▀\x1b[0m\x1b[38;2;59;197;13m\x1b[48;2;56;194;12m▀\x1b[0m\x1b[38;2;56;195;13m\x1b[48;2;54;193;12m▀\x1b[0m\x1b[38;2;54;193;12m\x1b[48;2;52;191;12m▀\x1b[0m\x1b[38;2;51;190;12m\x1b[48;2;49;188;12m▀\x1b[0m\x1b[38;2;48;187;11m\x1b[48;2;46;185;11m▀\x1b[0m\x1b[38;2;44;182;11m\x1b[48;2;43;181;11m▀\x1b[0m\x1b[38;2;40;178;11m\x1b[48;2;39;177;11m▀\x1b[0m\x1b[38;2;39;176;10m\x1b[48;2;37;175;10m▀\x1b[0m\x1b[38;2;36;174;10m\x1b[48;2;35;172;10m▀\x1b[0m\x1b[38;2;34;171;10m\x1b[48;2;33;169;10m▀\x1b[0m\x1b[38;2;31;167;10m\x1b[48;2;30;165;10m▀\x1b[0m\x1b[38;2;29;163;10m\x1b[48;2;27;160;10m▀\x1b[0m\x1b[38;2;26;158;10m\x1b[48;2;24;154;9m▀\x1b[0m\x1b[38;2;24;155;9m\x1b[48;2;22;151;9m▀\x1b[0m\x1b[38;2;22;151;9m\x1b[48;2;19;147;9m▀\x1b[0m\x1b[38;2;21;149;8m\x1b[48;2;19;145;8m▀\x1b[0m\x1b[38;2;24;154;8m\x1b[48;2;18;144;7m▀\x1b[0m\x1b[38;2;22;143;7m\x1b[48;2;15;133;6m▀\x1b[0m      \n     \x1b[38;2;89;212;19m\x1b[48;2;78;206;17m▀\x1b[0m\x1b[38;2;96;217;26m\x1b[48;2;86;212;21m▀\x1b[0m\x1b[38;2;69;202;14m\x1b[48;2;66;202;14m▀\x1b[0m\x1b[38;2;43;150;10m\x1b[48;2;5;81;5m▀\x1b[0m\x1b[38;2;4;81;5m▀\x1b[0m\x1b[38;2;3;80;5m▀\x1b[0m\x1b[38;2;3;78;4m▀\x1b[0m\x1b[38;2;3;79;5m▀\x1b[0m\x1b[38;2;3;79;5m▀\x1b[0m\x1b[38;2;3;79;5m▀\x1b[0m\x1b[38;2;4;83;5m▀\x1b[0m\x1b[38;2;33;146;9m\x1b[48;2;4;89;6m▀\x1b[0m\x1b[38;2;48;187;11m\x1b[48;2;49;188;12m▀\x1b[0m\x1b[38;2;46;186;11m\x1b[48;2;45;185;10m▀\x1b[0m\x1b[38;2;45;184;11m\x1b[48;2;44;183;10m▀\x1b[0m\x1b[38;2;43;182;10m\x1b[48;2;41;181;10m▀\x1b[0m\x1b[38;2;39;178;10m\x1b[48;2;39;177;10m▀\x1b[0m\x1b[38;2;37;175;11m\x1b[48;2;29;147;9m▀\x1b[0m\x1b[38;2;17;116;7m\x1b[48;2;2;66;4m▀\x1b[0m\x1b[38;2;2;76;5m▀\x1b[0m\x1b[38;2;2;75;5m▀\x1b[0m\x1b[38;2;2;74;5m▀\x1b[0m\x1b[38;2;2;73;6m▀\x1b[0m\x1b[38;2;2;73;5m▀\x1b[0m\x1b[38;2;2;72;5m▀\x1b[0m\x1b[38;2;2;80;6m▀\x1b[0m\x1b[38;2;14;126;8m\x1b[48;2;3;91;6m▀\x1b[0m\x1b[38;2;13;136;8m\x1b[48;2;13;135;8m▀\x1b[0m\x1b[38;2;10;123;6m\x1b[48;2;9;121;6m▀\x1b[0m\x1b[38;2;10;119;7m\x1b[48;2;9;118;7m▀\x1b[0m     \n    \x1b[38;2;4;85;6m▄\x1b[0m\x1b[38;2;59;192;13m\x1b[48;2;52;185;12m▀\x1b[0m\x1b[38;2;74;204;17m\x1b[48;2;68;201;15m▀\x1b[0m\x1b[38;2;44;160;11m\x1b[48;2;42;158;10m▀\x1b[0m  \x1b[38;2;58;215;10m▄\x1b[0m\x1b[38;2;42;172;11m\x1b[48;2;156;246;77m▀\x1b[0m\x1b[38;2;40;172;10m\x1b[48;2;132;242;59m▀\x1b[0m\x1b[38;2;26;154;8m\x1b[48;2;33;193;6m▀\x1b[0m\x1b[38;2;17;120;4m\x1b[48;2;21;175;5m▀\x1b[0m  \x1b[38;2;28;150;11m\x1b[48;2;27;152;11m▀\x1b[0m\x1b[38;2;42;182;10m\x1b[48;2;42;181;10m▀\x1b[0m\x1b[38;2;40;180;9m\x1b[48;2;39;179;9m▀\x1b[0m\x1b[38;2;39;177;9m\x1b[48;2;37;176;9m▀\x1b[0m\x1b[38;2;36;173;9m\x1b[48;2;35;172;9m▀\x1b[0m\x1b[38;2;2;77;5m\x1b[48;2;2;77;5m▀\x1b[0m  \x1b[38;2;34;155;7m\x1b[48;2;93;227;33m▀\x1b[0m\x1b[38;2;40;176;12m\x1b[48;2;158;246;79m▀\x1b[0m\x1b[38;2;27;160;7m\x1b[48;2;44;203;9m▀\x1b[0m\x1b[38;2;19;139;6m\x1b[48;2;21;175;4m▀\x1b[0m\x1b[38;2;19;154;6m▄\x1b[0m \x1b[38;2;2;54;5m\x1b[48;2;2;53;4m▀\x1b[0m\x1b[38;2;18;142;9m\x1b[48;2;18;142;9m▀\x1b[0m\x1b[38;2;8;118;6m\x1b[48;2;8;118;6m▀\x1b[0m\x1b[38;2;8;116;6m\x1b[48;2;6;105;6m▀\x1b[0m\x1b[38;2;1;56;5m▄\x1b[0m    \n  \x1b[38;2;19;109;11m\x1b[48;2;21;110;10m▀\x1b[0m\x1b[38;2;57;197;25m\x1b[48;2;70;205;33m▀\x1b[0m\x1b[38;2;22;158;13m\x1b[48;2;25;164;14m▀\x1b[0m\x1b[38;2;43;176;9m\x1b[48;2;43;177;9m▀\x1b[0m\x1b[38;2;58;195;13m\x1b[48;2;56;193;12m▀\x1b[0m\x1b[38;2;37;154;10m\x1b[48;2;36;153;9m▀\x1b[0m  \x1b[38;2;65;218;15m\x1b[48;2;48;208;8m▀\x1b[0m\x1b[38;2;201;254;115m\x1b[48;2;126;240;56m▀\x1b[0m\x1b[38;2;164;252;83m\x1b[48;2;84;225;30m▀\x1b[0m\x1b[38;2;28;189;4m\x1b[48;2;25;188;4m▀\x1b[0m\x1b[38;2;19;176;4m\x1b[48;2;20;179;4m▀\x1b[0m  \x1b[38;2;28;153;11m\x1b[48;2;29;154;11m▀\x1b[0m\x1b[38;2;38;177;9m\x1b[48;2;37;177;9m▀\x1b[0m\x1b[38;2;36;175;9m\x1b[48;2;35;174;9m▀\x1b[0m\x1b[38;2;34;171;9m\x1b[48;2;32;169;9m▀\x1b[0m\x1b[38;2;31;167;8m\x1b[48;2;29;165;8m▀\x1b[0m\x1b[38;2;1;76;5m\x1b[48;2;2;76;5m▀\x1b[0m \x1b[38;2;29;139;7m\x1b[48;2;28;138;6m▀\x1b[0m\x1b[38;2;134;243;59m\x1b[48;2;71;220;21m▀\x1b[0m\x1b[38;2;189;254;104m\x1b[48;2;113;236;48m▀\x1b[0m\x1b[38;2;53;209;13m\x1b[48;2;36;197;6m▀\x1b[0m\x1b[38;2;23;181;4m\x1b[48;2;23;183;4m▀\x1b[0m\x1b[38;2;19;177;4m\x1b[48;2;21;180;4m▀\x1b[0m \x1b[38;2;2;58;4m\x1b[48;2;3;59;5m▀\x1b[0m\x1b[38;2;18;142;9m\x1b[48;2;18;143;9m▀\x1b[0m\x1b[38;2;8;117;6m\x1b[48;2;8;117;6m▀\x1b[0m\x1b[38;2;5;100;5m\x1b[48;2;5;98;6m▀\x1b[0m\x1b[38;2;5;108;9m\x1b[48;2;8;118;10m▀\x1b[0m\x1b[38;2;24;153;15m\x1b[48;2;30;161;16m▀\x1b[0m   \n  \x1b[38;2;11;93;8m\x1b[48;2;8;82;7m▀\x1b[0m\x1b[38;2;19;144;12m\x1b[48;2;12;128;10m▀\x1b[0m\x1b[38;2;5;116;8m\x1b[48;2;2;104;7m▀\x1b[0m\x1b[38;2;34;165;7m\x1b[48;2;31;162;7m▀\x1b[0m\x1b[38;2;46;184;10m\x1b[48;2;44;181;10m▀\x1b[0m\x1b[38;2;31;146;8m\x1b[48;2;29;145;8m▀\x1b[0m  \x1b[38;2;35;199;5m\x1b[48;2;40;204;6m▀\x1b[0m\x1b[38;2;33;199;4m\x1b[48;2;37;203;4m▀\x1b[0m\x1b[38;2;33;198;4m\x1b[48;2;38;203;5m▀\x1b[0m\x1b[38;2;34;198;4m\x1b[48;2;38;204;5m▀\x1b[0m\x1b[38;2;34;198;5m\x1b[48;2;40;204;5m▀\x1b[0m  \x1b[38;2;28;152;10m\x1b[48;2;29;153;11m▀\x1b[0m\x1b[38;2;33;171;8m\x1b[48;2;32;169;9m▀\x1b[0m\x1b[38;2;29;166;9m\x1b[48;2;27;162;8m▀\x1b[0m\x1b[38;2;27;161;8m\x1b[48;2;24;158;8m▀\x1b[0m\x1b[38;2;24;156;7m\x1b[48;2;21;153;7m▀\x1b[0m\x1b[38;2;1;72;5m\x1b[48;2;1;71;5m▀\x1b[0m \x1b[38;2;29;140;6m▀\x1b[0m\x1b[38;2;36;200;4m\x1b[48;2;38;201;5m▀\x1b[0m\x1b[38;2;33;198;4m\x1b[48;2;36;201;4m▀\x1b[0m\x1b[38;2;34;199;4m\x1b[48;2;38;203;5m▀\x1b[0m\x1b[38;2;36;201;4m\x1b[48;2;40;204;5m▀\x1b[0m\x1b[38;2;35;200;5m\x1b[48;2;39;201;7m▀\x1b[0m \x1b[38;2;2;55;5m\x1b[48;2;2;56;4m▀\x1b[0m\x1b[38;2;19;142;9m\x1b[48;2;18;142;9m▀\x1b[0m\x1b[38;2;7;114;6m\x1b[48;2;7;114;6m▀\x1b[0m\x1b[38;2;4;93;6m\x1b[48;2;3;91;6m▀\x1b[0m\x1b[38;2;0;84;5m\x1b[48;2;0;74;4m▀\x1b[0m\x1b[38;2;9;116;9m\x1b[48;2;5;99;7m▀\x1b[0m   \n  \x1b[38;2;5;70;7m\x1b[48;2;7;72;8m▀\x1b[0m\x1b[38;2;2;83;6m\x1b[48;2;2;77;5m▀\x1b[0m\x1b[38;2;0;54;2m\x1b[48;2;0;42;1m▀\x1b[0m\x1b[38;2;26;153;7m\x1b[48;2;24;151;7m▀\x1b[0m\x1b[38;2;38;172;9m\x1b[48;2;35;169;9m▀\x1b[0m\x1b[38;2;29;161;9m\x1b[48;2;24;155;8m▀\x1b[0m\x1b[38;2;8;75;5m\x1b[48;2;11;119;8m▀\x1b[0m       \x1b[38;2;8;106;9m\x1b[48;2;26;158;14m▀\x1b[0m\x1b[38;2;41;175;14m\x1b[48;2;21;152;10m▀\x1b[0m\x1b[38;2;20;152;9m\x1b[48;2;12;139;8m▀\x1b[0m\x1b[38;2;19;150;9m\x1b[48;2;16;145;9m▀\x1b[0m\x1b[38;2;17;146;9m\x1b[48;2;15;142;8m▀\x1b[0m\x1b[38;2;14;140;8m\x1b[48;2;10;129;8m▀\x1b[0m\x1b[38;2;7;109;7m\x1b[48;2;10;130;8m▀\x1b[0m\x1b[38;2;3;98;7m▄\x1b[0m      \x1b[38;2;5;82;6m▄\x1b[0m\x1b[38;2;11;120;10m\x1b[48;2;35;152;14m▀\x1b[0m\x1b[38;2;11;130;9m\x1b[48;2;10;128;9m▀\x1b[0m\x1b[38;2;7;112;7m\x1b[48;2;6;111;7m▀\x1b[0m\x1b[38;2;4;91;6m\x1b[48;2;4;92;7m▀\x1b[0m\x1b[38;2;0;39;1m\x1b[48;2;0;35;0m▀\x1b[0m\x1b[38;2;1;72;5m\x1b[48;2;2;78;7m▀\x1b[0m   \n    \x1b[38;2;0;49;3m▀\x1b[0m\x1b[38;2;22;146;8m\x1b[48;2;22;144;8m▀\x1b[0m\x1b[38;2;30;162;9m\x1b[48;2;29;161;9m▀\x1b[0m\x1b[38;2;19;147;9m\x1b[48;2;17;145;9m▀\x1b[0m\x1b[38;2;18;146;9m\x1b[48;2;16;144;9m▀\x1b[0m\x1b[38;2;18;149;9m\x1b[48;2;16;145;10m▀\x1b[0m\x1b[38;2;19;151;9m\x1b[48;2;17;146;10m▀\x1b[0m\x1b[38;2;19;152;9m\x1b[48;2;16;146;10m▀\x1b[0m\x1b[38;2;19;151;10m\x1b[48;2;16;146;10m▀\x1b[0m\x1b[38;2;19;151;10m\x1b[48;2;16;145;10m▀\x1b[0m\x1b[38;2;18;149;9m\x1b[48;2;15;144;10m▀\x1b[0m\x1b[38;2;15;144;9m\x1b[48;2;12;139;9m▀\x1b[0m\x1b[38;2;12;133;9m\x1b[48;2;39;154;13m▀\x1b[0m\x1b[38;2;74;203;15m\x1b[48;2;59;200;10m▀\x1b[0m\x1b[38;2;46;154;8m\x1b[48;2;5;89;5m▀\x1b[0m\x1b[38;2;8;128;8m\x1b[48;2;9;128;8m▀\x1b[0m\x1b[38;2;9;126;8m\x1b[48;2;10;130;8m▀\x1b[0m\x1b[38;2;51;174;9m\x1b[48;2;11;105;6m▀\x1b[0m\x1b[38;2;58;179;10m\x1b[48;2;56;196;11m▀\x1b[0m\x1b[38;2;7;122;8m\x1b[48;2;23;132;8m▀\x1b[0m\x1b[38;2;11;133;9m\x1b[48;2;10;131;10m▀\x1b[0m\x1b[38;2;13;138;10m\x1b[48;2;11;134;10m▀\x1b[0m\x1b[38;2;12;138;10m\x1b[48;2;11;134;10m▀\x1b[0m\x1b[38;2;13;137;10m\x1b[48;2;11;133;10m▀\x1b[0m\x1b[38;2;13;137;10m\x1b[48;2;11;133;10m▀\x1b[0m\x1b[38;2;12;136;10m\x1b[48;2;10;132;10m▀\x1b[0m\x1b[38;2;11;133;10m\x1b[48;2;9;129;10m▀\x1b[0m\x1b[38;2;9;128;10m\x1b[48;2;8;126;10m▀\x1b[0m\x1b[38;2;7;123;9m\x1b[48;2;7;121;9m▀\x1b[0m\x1b[38;2;5;108;7m\x1b[48;2;5;107;7m▀\x1b[0m\x1b[38;2;4;92;7m\x1b[48;2;4;97;9m▀\x1b[0m\x1b[38;2;0;44;3m▀\x1b[0m    \n     \x1b[38;2;20;140;9m\x1b[48;2;19;135;9m▀\x1b[0m\x1b[38;2;25;154;8m\x1b[48;2;21;147;8m▀\x1b[0m\x1b[38;2;14;137;9m\x1b[48;2;13;134;9m▀\x1b[0m\x1b[38;2;13;137;9m\x1b[48;2;12;134;9m▀\x1b[0m\x1b[38;2;12;136;10m\x1b[48;2;11;134;10m▀\x1b[0m\x1b[38;2;12;137;10m\x1b[48;2;11;134;10m▀\x1b[0m\x1b[38;2;12;137;10m\x1b[48;2;11;134;10m▀\x1b[0m\x1b[38;2;12;136;11m\x1b[48;2;11;134;11m▀\x1b[0m\x1b[38;2;12;136;11m\x1b[48;2;10;133;10m▀\x1b[0m\x1b[38;2;10;134;10m\x1b[48;2;10;132;10m▀\x1b[0m\x1b[38;2;9;130;9m\x1b[48;2;9;129;10m▀\x1b[0m\x1b[38;2;14;117;8m\x1b[48;2;3;94;6m▀\x1b[0m\x1b[38;2;23;163;11m\x1b[48;2;17;152;11m▀\x1b[0m\x1b[38;2;6;114;8m\x1b[48;2;17;144;10m▀\x1b[0m\x1b[38;2;6;122;9m\x1b[48;2;4;118;9m▀\x1b[0m\x1b[38;2;6;122;9m\x1b[48;2;5;118;9m▀\x1b[0m\x1b[38;2;13;120;10m\x1b[48;2;26;154;13m▀\x1b[0m\x1b[38;2;27;169;11m\x1b[48;2;19;137;9m▀\x1b[0m\x1b[38;2;12;97;6m\x1b[48;2;1;85;6m▀\x1b[0m\x1b[38;2;6;120;9m\x1b[48;2;6;120;10m▀\x1b[0m\x1b[38;2;8;125;10m\x1b[48;2;7;123;10m▀\x1b[0m\x1b[38;2;7;126;10m\x1b[48;2;7;123;10m▀\x1b[0m\x1b[38;2;8;125;10m\x1b[48;2;7;122;10m▀\x1b[0m\x1b[38;2;8;124;10m\x1b[48;2;7;121;10m▀\x1b[0m\x1b[38;2;7;123;10m\x1b[48;2;6;120;10m▀\x1b[0m\x1b[38;2;6;120;10m\x1b[48;2;6;117;9m▀\x1b[0m\x1b[38;2;6;117;9m\x1b[48;2;5;114;9m▀\x1b[0m\x1b[38;2;5;113;8m\x1b[48;2;5;111;8m▀\x1b[0m\x1b[38;2;4;101;7m\x1b[48;2;3;95;6m▀\x1b[0m\x1b[38;2;4;100;9m\x1b[48;2;5;97;10m▀\x1b[0m     \n      \x1b[38;2;7;109;7m\x1b[48;2;10;103;9m▀\x1b[0m\x1b[38;2;11;124;8m\x1b[48;2;4;97;6m▀\x1b[0m\x1b[38;2;9;124;8m\x1b[48;2;9;119;8m▀\x1b[0m\x1b[38;2;8;125;9m\x1b[48;2;8;124;9m▀\x1b[0m\x1b[38;2;8;125;9m\x1b[48;2;7;123;9m▀\x1b[0m\x1b[38;2;8;125;10m\x1b[48;2;7;123;9m▀\x1b[0m\x1b[38;2;8;125;10m\x1b[48;2;7;123;10m▀\x1b[0m\x1b[38;2;8;125;10m\x1b[48;2;7;123;10m▀\x1b[0m\x1b[38;2;7;124;10m\x1b[48;2;7;123;10m▀\x1b[0m\x1b[38;2;7;123;10m\x1b[48;2;6;122;10m▀\x1b[0m\x1b[38;2;6;120;10m\x1b[48;2;5;120;10m▀\x1b[0m\x1b[38;2;4;114;9m\x1b[48;2;4;118;9m▀\x1b[0m\x1b[38;2;1;91;7m\x1b[48;2;4;114;9m▀\x1b[0m\x1b[38;2;3;111;8m\x1b[48;2;4;115;9m▀\x1b[0m\x1b[38;2;4;112;8m\x1b[48;2;4;114;9m▀\x1b[0m\x1b[38;2;1;88;7m\x1b[48;2;3;111;9m▀\x1b[0m\x1b[38;2;4;112;9m\x1b[48;2;4;115;10m▀\x1b[0m\x1b[38;2;4;116;10m\x1b[48;2;4;116;10m▀\x1b[0m\x1b[38;2;5;116;10m\x1b[48;2;5;116;10m▀\x1b[0m\x1b[38;2;5;116;10m\x1b[48;2;4;115;10m▀\x1b[0m\x1b[38;2;5;115;9m\x1b[48;2;4;114;9m▀\x1b[0m\x1b[38;2;5;114;10m\x1b[48;2;4;112;9m▀\x1b[0m\x1b[38;2;4;113;10m\x1b[48;2;4;111;9m▀\x1b[0m\x1b[38;2;4;111;9m\x1b[48;2;4;109;9m▀\x1b[0m\x1b[38;2;4;108;9m\x1b[48;2;4;106;9m▀\x1b[0m\x1b[38;2;4;106;8m\x1b[48;2;3;97;8m▀\x1b[0m\x1b[38;2;3;95;7m\x1b[48;2;0;73;5m▀\x1b[0m\x1b[38;2;1;83;7m\x1b[48;2;4;84;9m▀\x1b[0m      \n                                        \n       \x1b[38;2;5;72;9m▄\x1b[0m\x1b[38;2;1;57;4m▄\x1b[0m\x1b[38;2;13;100;9m\x1b[48;2;24;153;12m▀\x1b[0m\x1b[38;2;28;152;18m\x1b[48;2;79;213;36m▀\x1b[0m\x1b[38;2;56;185;25m\x1b[48;2;43;172;15m▀\x1b[0m\x1b[38;2;43;173;17m\x1b[48;2;33;161;11m▀\x1b[0m\x1b[38;2;33;163;13m\x1b[48;2;25;152;9m▀\x1b[0m\x1b[38;2;22;149;10m\x1b[48;2;18;140;8m▀\x1b[0m\x1b[38;2;17;139;9m\x1b[48;2;14;132;8m▀\x1b[0m\x1b[38;2;14;133;9m\x1b[48;2;12;130;8m▀\x1b[0m\x1b[38;2;13;131;9m\x1b[48;2;11;127;8m▀\x1b[0m\x1b[38;2;11;129;9m\x1b[48;2;10;124;8m▀\x1b[0m\x1b[38;2;10;126;8m\x1b[48;2;9;123;8m▀\x1b[0m\x1b[38;2;10;125;8m\x1b[48;2;9;121;7m▀\x1b[0m\x1b[38;2;10;124;8m\x1b[48;2;9;120;8m▀\x1b[0m\x1b[38;2;10;124;8m\x1b[48;2;8;120;8m▀\x1b[0m\x1b[38;2;10;124;8m\x1b[48;2;8;119;8m▀\x1b[0m\x1b[38;2;10;125;8m\x1b[48;2;8;119;8m▀\x1b[0m\x1b[38;2;11;126;8m\x1b[48;2;9;118;8m▀\x1b[0m\x1b[38;2;12;128;8m\x1b[48;2;9;119;7m▀\x1b[0m\x1b[38;2;15;133;8m\x1b[48;2;10;120;7m▀\x1b[0m\x1b[38;2;15;130;9m\x1b[48;2;13;126;7m▀\x1b[0m\x1b[38;2;4;102;7m\x1b[48;2;10;118;6m▀\x1b[0m\x1b[38;2;5;94;8m▄\x1b[0m\x1b[38;2;2;56;6m▄\x1b[0m\x1b[38;2;3;58;7m▄\x1b[0m       \n     \x1b[38;2;9;127;15m\x1b[48;2;34;167;32m▀\x1b[0m\x1b[38;2;43;182;40m\x1b[48;2;21;140;22m▀\x1b[0m\x1b[38;2;5;101;11m\x1b[48;2;0;67;4m▀\x1b[0m\x1b[38;2;0;51;2m\x1b[48;2;0;38;1m▀\x1b[0m\x1b[38;2;31;163;11m\x1b[48;2;29;161;10m▀\x1b[0m\x1b[38;2;27;158;8m\x1b[48;2;27;158;8m▀\x1b[0m\x1b[38;2;26;158;8m\x1b[48;2;26;157;8m▀\x1b[0m\x1b[38;2;26;148;9m\x1b[48;2;16;117;7m▀\x1b[0m\x1b[38;2;1;59;5m▀\x1b[0m            \x1b[38;2;1;74;6m▀\x1b[0m\x1b[38;2;11;119;7m\x1b[48;2;10;116;7m▀\x1b[0m\x1b[38;2;11;117;7m\x1b[48;2;11;117;7m▀\x1b[0m\x1b[38;2;9;116;6m\x1b[48;2;9;116;6m▀\x1b[0m\x1b[38;2;1;87;6m\x1b[48;2;1;86;6m▀\x1b[0m\x1b[38;2;0;49;2m\x1b[48;2;0;39;1m▀\x1b[0m\x1b[38;2;2;94;9m\x1b[48;2;0;75;6m▀\x1b[0m\x1b[38;2;3;99;9m\x1b[48;2;8;118;12m▀\x1b[0m\x1b[38;2;3;91;11m\x1b[48;2;1;84;8m▀\x1b[0m     \n    \x1b[38;2;9;125;12m\x1b[48;2;8;123;11m▀\x1b[0m\x1b[38;2;19;138;19m\x1b[48;2;10;121;13m▀\x1b[0m\x1b[38;2;0;63;4m\x1b[48;2;0;57;3m▀\x1b[0m  \x1b[38;2;25;157;10m\x1b[48;2;25;156;10m▀\x1b[0m\x1b[38;2;24;153;8m\x1b[48;2;23;151;8m▀\x1b[0m\x1b[38;2;24;152;8m\x1b[48;2;23;150;8m▀\x1b[0m\x1b[38;2;13;108;7m\x1b[48;2;13;107;8m▀\x1b[0m    \x1b[38;2;75;171;13m▄\x1b[0m\x1b[38;2;61;162;10m▄\x1b[0m  \x1b[38;2;51;170;8m\x1b[48;2;37;123;6m▀\x1b[0m\x1b[38;2;49;158;7m▄\x1b[0m    \x1b[38;2;14;123;8m\x1b[48;2;14;124;8m▀\x1b[0m\x1b[38;2;11;117;7m\x1b[48;2;10;116;8m▀\x1b[0m\x1b[38;2;10;115;7m\x1b[48;2;9;114;7m▀\x1b[0m\x1b[38;2;1;87;6m\x1b[48;2;1;87;6m▀\x1b[0m  \x1b[38;2;0;83;7m\x1b[48;2;0;81;7m▀\x1b[0m\x1b[38;2;5;106;11m\x1b[48;2;5;107;11m▀\x1b[0m\x1b[38;2;3;83;9m\x1b[48;2;1;80;8m▀\x1b[0m    \n    \x1b[38;2;6;118;10m\x1b[48;2;6;115;9m▀\x1b[0m\x1b[38;2;7;110;10m\x1b[48;2;6;110;11m▀\x1b[0m\x1b[38;2;0;58;3m\x1b[48;2;0;58;4m▀\x1b[0m  \x1b[38;2;22;151;9m\x1b[48;2;20;149;9m▀\x1b[0m\x1b[38;2;19;143;8m\x1b[48;2;18;140;7m▀\x1b[0m\x1b[38;2;19;143;7m\x1b[48;2;18;140;7m▀\x1b[0m\x1b[38;2;11;104;7m\x1b[48;2;11;103;7m▀\x1b[0m  \x1b[38;2;20;106;6m▄\x1b[0m\x1b[38;2;35;155;9m\x1b[48;2;27;146;10m▀\x1b[0m   \x1b[38;2;39;172;10m\x1b[48;2;28;154;11m▀\x1b[0m   \x1b[38;2;27;153;9m\x1b[48;2;17;136;10m▀\x1b[0m  \x1b[38;2;13;123;8m\x1b[48;2;13;122;8m▀\x1b[0m\x1b[38;2;9;112;7m\x1b[48;2;8;111;7m▀\x1b[0m\x1b[38;2;8;110;7m\x1b[48;2;7;110;7m▀\x1b[0m\x1b[38;2;1;85;6m\x1b[48;2;1;85;6m▀\x1b[0m  \x1b[38;2;1;83;7m\x1b[48;2;0;81;7m▀\x1b[0m\x1b[38;2;5;108;11m\x1b[48;2;4;106;11m▀\x1b[0m\x1b[38;2;1;77;7m\x1b[48;2;1;76;7m▀\x1b[0m    \n   \x1b[38;2;38;131;10m▄\x1b[0m\x1b[38;2;27;132;10m\x1b[48;2;85;211;22m▀\x1b[0m\x1b[38;2;24;127;9m\x1b[48;2;56;187;15m▀\x1b[0m\x1b[38;2;10;73;4m\x1b[48;2;36;166;11m▀\x1b[0m  \x1b[38;2;17;141;8m\x1b[48;2;17;141;8m▀\x1b[0m\x1b[38;2;13;130;7m\x1b[48;2;12;128;7m▀\x1b[0m\x1b[38;2;13;129;7m\x1b[48;2;12;126;7m▀\x1b[0m\x1b[38;2;8;97;6m\x1b[48;2;8;96;6m▀\x1b[0m    \x1b[38;2;16;110;7m▀\x1b[0m\x1b[38;2;15;97;6m▀\x1b[0m\x1b[38;2;19;120;9m\x1b[48;2;21;145;10m▀\x1b[0m  \x1b[38;2;18;142;11m▀\x1b[0m    \x1b[38;2;13;121;8m\x1b[48;2;13;120;8m▀\x1b[0m\x1b[38;2;8;109;7m\x1b[48;2;8;109;8m▀\x1b[0m\x1b[38;2;7;107;7m\x1b[48;2;6;107;7m▀\x1b[0m\x1b[38;2;1;84;6m\x1b[48;2;1;84;6m▀\x1b[0m  \x1b[38;2;14;104;8m\x1b[48;2;58;197;18m▀\x1b[0m\x1b[38;2;19;126;10m\x1b[48;2;45;173;14m▀\x1b[0m\x1b[38;2;11;100;7m\x1b[48;2;35;168;13m▀\x1b[0m    \n  \x1b[38;2;65;198;20m\x1b[48;2;43;175;15m▀\x1b[0m\x1b[38;2;17;144;11m\x1b[48;2;15;140;11m▀\x1b[0m\x1b[38;2;14;127;9m\x1b[48;2;3;77;4m▀\x1b[0m\x1b[38;2;10;115;8m\x1b[48;2;4;68;3m▀\x1b[0m\x1b[38;2;11;128;9m\x1b[48;2;10;118;8m▀\x1b[0m\x1b[38;2;8;113;6m\x1b[48;2;8;113;7m▀\x1b[0m \x1b[38;2;13;130;7m\x1b[48;2;11;123;7m▀\x1b[0m\x1b[38;2;10;121;7m\x1b[48;2;9;119;7m▀\x1b[0m\x1b[38;2;9;119;7m\x1b[48;2;8;117;7m▀\x1b[0m\x1b[38;2;7;104;7m\x1b[48;2;9;117;8m▀\x1b[0m\x1b[38;2;2;84;8m▄\x1b[0m\x1b[38;2;0;61;4m▄\x1b[0m\x1b[38;2;1;62;5m▄\x1b[0m\x1b[38;2;2;65;5m▄\x1b[0m\x1b[38;2;0;63;5m▄\x1b[0m\x1b[38;2;1;66;5m▄\x1b[0m\x1b[38;2;1;63;5m▄\x1b[0m\x1b[38;2;1;64;5m▄\x1b[0m\x1b[38;2;0;62;5m▄\x1b[0m\x1b[38;2;1;62;5m▄\x1b[0m\x1b[38;2;0;62;5m▄\x1b[0m\x1b[38;2;0;58;5m▄\x1b[0m\x1b[38;2;2;63;5m▄\x1b[0m\x1b[38;2;2;67;6m\x1b[48;2;9;115;11m▀\x1b[0m\x1b[38;2;16;126;10m\x1b[48;2;8;110;8m▀\x1b[0m\x1b[38;2;7;106;8m\x1b[48;2;6;105;8m▀\x1b[0m\x1b[38;2;6;105;8m\x1b[48;2;5;103;8m▀\x1b[0m\x1b[38;2;1;84;6m\x1b[48;2;1;86;7m▀\x1b[0m \x1b[38;2;14;130;9m\x1b[48;2;10;122;9m▀\x1b[0m\x1b[38;2;10;122;9m\x1b[48;2;6;95;6m▀\x1b[0m\x1b[38;2;6;99;7m\x1b[48;2;1;52;3m▀\x1b[0m\x1b[38;2;7;109;8m\x1b[48;2;2;80;5m▀\x1b[0m\x1b[38;2;5;103;7m\x1b[48;2;5;101;8m▀\x1b[0m\x1b[38;2;10;101;10m\x1b[48;2;7;100;8m▀\x1b[0m  \n  \x1b[38;2;16;133;9m\x1b[48;2;13;125;9m▀\x1b[0m\x1b[38;2;6;100;7m\x1b[48;2;6;105;7m▀\x1b[0m   \x1b[38;2;8;112;8m\x1b[48;2;5;97;7m▀\x1b[0m \x1b[38;2;7;82;7m▀\x1b[0m\x1b[38;2;2;86;6m\x1b[48;2;3;89;7m▀\x1b[0m\x1b[38;2;7;108;7m\x1b[48;2;2;79;6m▀\x1b[0m\x1b[38;2;7;111;8m\x1b[48;2;2;82;6m▀\x1b[0m\x1b[38;2;7;112;8m\x1b[48;2;2;82;6m▀\x1b[0m\x1b[38;2;7;112;8m\x1b[48;2;2;82;6m▀\x1b[0m\x1b[38;2;7;112;8m\x1b[48;2;2;82;6m▀\x1b[0m\x1b[38;2;7;112;8m\x1b[48;2;2;82;6m▀\x1b[0m\x1b[38;2;6;111;8m\x1b[48;2;2;81;6m▀\x1b[0m\x1b[38;2;6;111;8m\x1b[48;2;2;81;6m▀\x1b[0m\x1b[38;2;6;108;8m\x1b[48;2;1;79;5m▀\x1b[0m\x1b[38;2;6;108;8m\x1b[48;2;1;78;5m▀\x1b[0m\x1b[38;2;6;107;8m\x1b[48;2;2;78;5m▀\x1b[0m\x1b[38;2;5;106;8m\x1b[48;2;1;78;5m▀\x1b[0m\x1b[38;2;5;105;8m\x1b[48;2;2;77;5m▀\x1b[0m\x1b[38;2;5;104;8m\x1b[48;2;1;76;5m▀\x1b[0m\x1b[38;2;5;103;8m\x1b[48;2;2;76;5m▀\x1b[0m\x1b[38;2;4;102;7m\x1b[48;2;1;76;5m▀\x1b[0m\x1b[38;2;5;100;8m\x1b[48;2;1;73;6m▀\x1b[0m\x1b[38;2;3;86;6m\x1b[48;2;0;70;5m▀\x1b[0m\x1b[38;2;0;68;5m\x1b[48;2;2;84;8m▀\x1b[0m  \x1b[38;2;10;117;8m\x1b[48;2;10;116;9m▀\x1b[0m   \x1b[38;2;4;98;8m\x1b[48;2;4;96;8m▀\x1b[0m\x1b[38;2;3;88;7m\x1b[48;2;5;92;8m▀\x1b[0m  \n   \x1b[38;2;5;92;7m▀\x1b[0m\x1b[38;2;3;91;7m▀\x1b[0m                              \x1b[38;2;3;88;7m▀\x1b[0m\x1b[38;2;8;90;8m▀\x1b[0m   \n          \x1b[38;2;7;112;12m\x1b[48;2;4;109;11m▀\x1b[0m\x1b[38;2;26;163;21m\x1b[48;2;10;128;12m▀\x1b[0m\x1b[38;2;23;155;18m\x1b[48;2;8;123;11m▀\x1b[0m\x1b[38;2;18;146;16m\x1b[48;2;7;117;11m▀\x1b[0m\x1b[38;2;13;135;14m\x1b[48;2;6;113;11m▀\x1b[0m\x1b[38;2;6;117;12m\x1b[48;2;3;104;10m▀\x1b[0m\x1b[38;2;1;91;10m\x1b[48;2;1;84;8m▀\x1b[0m\x1b[38;2;3;62;7m\x1b[48;2;1;71;8m▀\x1b[0m    \x1b[38;2;2;84;10m\x1b[48;2;1;79;8m▀\x1b[0m\x1b[38;2;2;95;10m\x1b[48;2;2;91;9m▀\x1b[0m\x1b[38;2;9;123;13m\x1b[48;2;3;103;10m▀\x1b[0m\x1b[38;2;8;120;13m\x1b[48;2;3;101;10m▀\x1b[0m\x1b[38;2;6;113;11m\x1b[48;2;2;95;9m▀\x1b[0m\x1b[38;2;4;102;11m\x1b[48;2;2;89;9m▀\x1b[0m\x1b[38;2;0;76;7m\x1b[48;2;0;70;6m▀\x1b[0m\x1b[38;2;4;68;8m\x1b[48;2;1;71;8m▀\x1b[0m          \n                                        \n""",
    'show_ascii_on_startup': True,
    'system_prompt': """You are Core Coder V5, an AI agent built with LangChain 1.0.\n\nA DevOps engineer focused on infrastructure, automation, and reliability.

Your expertise includes:
- CI/CD pipeline design and optimization
- Cloud infrastructure (AWS, Azure, GCP)
- Container orchestration (Docker, Kubernetes)
- Monitoring and alerting systems
- Security and compliance

Provide infrastructure-as-code examples, emphasize automation, and prioritize reliability and scalability.\n\nSHELL ACCESS:
You have access to a persistent shell session via ShellToolMiddleware.
This is SEPARATE from your regular tools - it's always available but hidden.

SHELL COMMANDS (run via shell middleware):
- System info: nvidia-smi, Get-ComputerInfo, systeminfo
- File operations: dir, ls, cat, type, echo, mkdir, rm
- Run programs: python script.py, node app.js, npm start
- Package management: pip install, npm install
- Git: git status, git commit, git push
- Any PowerShell/Bash command

NOTE: Shell commands are different from your LangChain tools.
- Tools (like read_file_content, code_analyzer) are function calls
- Shell commands are system commands executed in a terminal

When using shell:
- Explain what you're doing BEFORE running commands
- Show the exact command syntax
- Report output clearly
- Session is persistent (cd, env vars maintained)
- 120-second timeout
- Be careful with destructive operations\n\nBe helpful, precise, and efficient in your responses."""
}

# ============================================================================
# CONFIG PERSISTENCE
# ============================================================================

CONFIG_FILE = Path(__file__).parent / "agent_config.json"

def load_saved_config():
    """Load saved config from agent_config.json if it exists."""
    global AGENT_CONFIG
    if CONFIG_FILE.exists():
        try:
            import json
            with open(CONFIG_FILE, 'r') as f:
                saved = json.load(f)
                # Only override model and provider from saved config
                if 'model' in saved:
                    AGENT_CONFIG['model'] = saved['model']
                if 'provider' in saved:
                    AGENT_CONFIG['provider'] = saved['provider']
                if 'temperature' in saved:
                    AGENT_CONFIG['temperature'] = saved['temperature']
        except Exception as e:
            pass  # Silently ignore errors, use defaults

def save_config():
    """Save current model/provider to agent_config.json for persistence."""
    try:
        import json
        save_data = {
            'model': AGENT_CONFIG['model'],
            'provider': AGENT_CONFIG['provider'],
            'temperature': AGENT_CONFIG['temperature']
        }
        with open(CONFIG_FILE, 'w') as f:
            json.dump(save_data, f, indent=2)
        return True
    except Exception as e:
        return False

# Load saved config on startup
load_saved_config()

# ============================================================================
# BANNER DISPLAY FUNCTION
# ============================================================================

def print_banner():
    """Display ASCII art banner and/or pixel art from config."""
    banner_order = AGENT_CONFIG.get('banner_order', 'banner-first')
    show_banner = AGENT_CONFIG.get('show_ascii_on_startup') and AGENT_CONFIG.get('ascii_art')
    show_pixel = AGENT_CONFIG.get('show_pixel_art') and AGENT_CONFIG.get('pixel_ascii_art')
    
    def display_ascii_banner():
        if show_banner:
            color = AGENT_CONFIG.get('ascii_art_color', '#00FF00')
            if color.startswith('#') and len(color) == 7:
                r = int(color[1:3], 16)
                g = int(color[3:5], 16)
                b = int(color[5:7], 16)
                print("\033[38;2;" + str(r) + ";" + str(g) + ";" + str(b) + "m" + AGENT_CONFIG['ascii_art'] + "\033[0m")
            else:
                print(AGENT_CONFIG['ascii_art'])
            print()
    
    def display_pixel_art():
        if show_pixel:
            # Pixel art already has ANSI color codes embedded
            print(AGENT_CONFIG['pixel_ascii_art'])
            print()
    
    # Display in order specified by banner_order
    if banner_order == 'pixel-first':
        display_pixel_art()
        display_ascii_banner()
    else:
        display_ascii_banner()
        display_pixel_art()
# ============================================================================
# TOOLS - Import from configured toolboxes
# ============================================================================

# Import specific tools selected in UI
from tools import (
    get_file_tree,
    read_file,
    list_directory,
    search_in_files,
    get_python_info,
    ingest_reference_file,
    search_knowledge_base,
    get_conversation_summary,
    propose_file_create,
    propose_file_edit,
    propose_file_delete,
)

# Custom tools from UI


# ============================================================================
# AGENT FACTORY FUNCTION
# ============================================================================
# 
# DESIGN PATTERN: Factory Function (not a class constructor)
# ----------------------------------------------------------
# This factory function creates and returns a configured Agent instance.
# 
# WHY: Allows runtime configuration via parameters (project_root, kwargs)
#      while keeping the base Agent class flexible and reusable.
# 
# USAGE IN CLI:
#   1. This function is assigned to CoreCoderV5 (the function itself, not called)
#   2. CLI calls CoreCoderV5() to create an instance when needed
#   3. Multiple instances can be created with different parameters
# 
# CRITICAL: Do NOT call this function here - just define it!
#           It will be called later by the CLI when needed.
# ============================================================================

def create_core_coder_v5_agent(project_root: str = ".", **kwargs):
    """
    Factory function to create Core Coder V5 agent instances.
    
    This function dynamically loads tools from configured toolboxes and
    creates an Agent with the specified configuration.
    
    Configured Toolboxes:
    - coding toolbox (provides domain-specific tools)
    
    Features:
    - Shell middleware: Enabled (LangChain ShellToolMiddleware)
    - Memory: Enabled (conversation history)
    - RAG: Enabled (knowledge base search)
    
    Args:
        project_root: Root directory for agent operations (default: current directory)
        **kwargs: Additional parameters passed to Agent constructor
        
    Returns:
        Agent: Configured agent instance ready for use
    """
    
    # ========================================================================
    # STEP 1: Load tools from toolboxes (dynamic tool loading)
    # ========================================================================
    # The toolbox system provides category-based tool collections:
    #   - 'coding': File ops, git, code analysis, syntax checking
    #   - 'math': Calculator, matrix ops, quadratic solver, symbolic math
    #   - 'science': Unit converter, chemistry, physics calculations
    #   - 'custom': User-created tools from UI
    #   - 'generated': LLM-generated tools from toolbox system
    #
    # NOTE: We load from toolboxes only (not baseTools) to avoid duplicates.
    #       The toolbox system already includes all standard tools.
    
    tools = []
    seen_tools = set()  # Track tool names to prevent duplicates
    
    toolbox = get_toolbox()
    for toolbox_name in AGENT_CONFIG['toolboxes']:
        try:
            category_tools = toolbox.get_tools_by_category(toolbox_name)
            for tool in category_tools:
                tool_name = getattr(tool, 'name', str(tool))
                if tool_name not in seen_tools:
                    tools.append(tool)
                    seen_tools.add(tool_name)
            print(f"✓ Loaded tools from '{toolbox_name}' toolbox")
        except Exception as e:
            print(f"⚠ Could not load toolbox '{toolbox_name}': {e}")
    
    # ========================================================================
    # STEP 2: Add custom tools created in UI (if any)
    # ========================================================================

    
    print(f"✓ Total unique tools loaded: {len(tools)}")
    
    # ========================================================================
    # STEP 4: Setup middleware (LangChain middleware, not tools)
    # ========================================================================
    # Middleware extends agent capabilities at the execution layer:
    #   - ShellToolMiddleware: Persistent shell session for command execution
    #   - ContextEditingMiddleware: Advanced context manipulation (future)
    #   - HumanInLoopMiddleware: Approval prompts for sensitive ops (future)
    #
    # NOTE: Middleware is separate from tools - it's a LangChain concept
    #       for extending agent behavior without adding tools to the tool list.
    
    middleware = []
    if AGENT_CONFIG['enable_shell'] and SHELL_MIDDLEWARE_AVAILABLE:
        middleware.append(
            ShellToolMiddleware(
                workspace_root=project_root or '.',
                execution_policy=HostExecutionPolicy(),
                tool_description="Execute shell commands in a persistent terminal session. Use for system operations, running commands, file operations, etc."
            )
        )
        print("✓ Shell middleware enabled")
    
    # ========================================================================
    # STEP 5: Create Agent with dynamic configuration
    # ========================================================================
    # Using the base Agent class with all the tools and middleware we collected.
    # This is the NEW architecture (not create_ultimate_coding_agent factory).
    #
    # Benefits:
    #   - Supports any agent type (coding, math, science, hybrid)
    #   - Dynamic tool loading from toolbox system
    #   - UI controls everything via AGENT_CONFIG
    #   - Python handles implementation, UI handles metadata
    #
    # Handle CLI overrides: kwargs can override config values
    # Extract parameters that might come from CLI (to avoid duplicate keyword args)
    enable_memory = kwargs.pop('enable_memory', AGENT_CONFIG['memory_enabled'])
    enable_rag = kwargs.pop('enable_rag', AGENT_CONFIG['rag_enabled'])
    
    # Create agent with shell middleware if enabled
    # Note: Ollama models don't need provider prefix, just use model name directly
    # Groq models can use provider/model format if needed
    model_name = AGENT_CONFIG['model']
    provider = AGENT_CONFIG.get('provider', 'groq')
    
    # Build Agent() constructor parameters
    agent_params = {
        'name': AGENT_CONFIG['name'],
        'system_prompt': AGENT_CONFIG['system_prompt'],
        'tools': tools,  # Dynamically loaded tools
        'model_name': model_name,
        'provider': provider,  # Critical: tells Agent to use ChatOllama vs ChatGroq
        'temperature': AGENT_CONFIG['temperature'],
        'enable_memory': enable_memory,  # From config or CLI override
    }
    
    # Add shell middleware parameters if enabled
    if AGENT_CONFIG['enable_shell'] and SHELL_MIDDLEWARE_AVAILABLE:
        agent_params['enable_shell_tool'] = True
        agent_params['workspace_root'] = project_root or '.'
        agent_params['shell_timeout'] = 120  # 120 second timeout for shell commands
        print(f"✓ Shell enabled with workspace: {agent_params['workspace_root']}")
    
    # Add any CLI overrides
    agent_params.update(kwargs)
    
    agent = Agent(**agent_params)
    
    return agent


# ============================================================================
# EXPORT FACTORY AS CALLABLE CLASS
# ============================================================================
# 
# CRITICAL: Assign the FUNCTION ITSELF, not the result of calling it!
# ----------------------------------------------------------------------
# 
# ✅ CORRECT:   CoreCoderV5 = create_core_coder_v5_agent
# ❌ WRONG:     CoreCoderV5 = create_core_coder_v5_agent()
# 
# WHY:
#   - The CLI will call CoreCoderV5() later to create instances
#   - If we called it here with (), we'd create an instance now
#   - Then CLI would try to "call" that instance like CoreCoderV5()
#   - Result: TypeError: 'Agent' object is not callable
# 
# PATTERN:
#   CoreCoderV5 is the factory function → CLI calls it → creates Agent instance
# 
# USAGE EXAMPLE:
#   agent = CoreCoderV5(project_root="/my-project")  # CLI does this
# 
# ============================================================================

CoreCoderV5 = create_core_coder_v5_agent  # Assign function, don't call it!

# ============================================================================
# CLI INTERFACE
# ============================================================================
# 
# This is where CoreCoderV5 (the factory function) is actually CALLED.
# The function was defined above but not executed - now we execute it.
# 
# FLOW:
#   1. User runs: python cli.py "query here"
#   2. main() is called
#   3. main() calls CoreCoderV5() to create an agent instance
#   4. Agent instance is used to process queries
# 
# ============================================================================

def main():
    """CLI interface for Core Coder V5"""
    import argparse
    
    parser = argparse.ArgumentParser(description="A custom CLI agent created with Agent Forge")
    parser.add_argument("query", nargs="?", help="Your query or command")
    parser.add_argument("--memory", action="store_true", help="Enable conversation memory")
    parser.add_argument("--rag", action="store_true", help="Enable RAG for knowledge base")
    parser.add_argument("--interactive", "-i", action="store_true", help="Interactive mode")
    
    args = parser.parse_args()
    
    # ========================================================================
    # Create agent instance by CALLING the factory function
    # ========================================================================
    # CoreCoderV5 is the factory function we assigned earlier.
    # Calling it with () executes the function and returns an Agent instance.
    # 
    # This is where the agent is actually created and configured!
    # ========================================================================
    
    agent = CoreCoderV5(  # <-- This CALLS create_core_coder_v5_agent()
        enable_memory=args.memory,
        enable_rag=args.rag
    )
    
    # Display banner on startup
    print_banner()
    
    if args.interactive or not args.query:
        # Interactive mode
        print(f"Core Coder V5 - Interactive Mode")
        print("Type 'exit' or 'quit' to end the session\n")
        
        while True:
            try:
                query = input("You: ").strip()
                if query.lower() in ['exit', 'quit']:
                    break
                if not query:
                    continue
                    
                response = agent.chat(query)
                print(f"\nAgent: {response}\n")
                
            except KeyboardInterrupt:
                print("\n\nGoodbye!")
                break
            except Exception as e:
                print(f"Error: {e}")
    else:
        # Single query mode
        response = agent.chat(args.query)
        print(response)

if __name__ == "__main__":
    main()
